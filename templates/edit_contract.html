<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit School Contract</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    :root { --brand:#00ffff; --gap:14px; }
    body { font-family: system-ui, Arial, sans-serif; margin:0; padding:24px; color:#e8f0f2; background:#0f1c22; }
    .container { max-width: 960px; margin: 0 auto; }
    h1,h2,h3 { color: var(--brand); margin: 0 0 12px; }
    .back { display:inline-block; margin:0 0 18px; color:#7ec8ff; text-decoration:none; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    @media (max-width: 800px){ .grid-2{ grid-template-columns:1fr; } }
    label { font-weight: 600; display:block; margin: 6px 0; }
    input, select { width:100%; padding:12px; border-radius:10px; border:1px solid #2b4956; background:#142831; color:#dfe8ec; }
    .card { border:1px solid #274653; border-radius:14px; padding:16px; background:#0f242d; }
    .child { margin-bottom: 14px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    @media (max-width: 800px){ .row{ grid-template-columns:1fr; } }
    .actions { display:flex; gap:10px; margin-top:18px; }
    .btn { border:0; border-radius:12px; padding:10px 14px; cursor:pointer; }
    .btn-primary { background:#0ea5e9; color:#001018; font-weight:700; }
    .btn-ghost { background:#15333f; color:#cbe8f6; }
    .btn-danger { background:#ef4444; color:white; }
    hr { border:0; height:1px; background:#24424f; margin:22px 0; }
    small.hint { color:#9fb7c2; display:block; margin-top:4px; }
    .inline { display:flex; align-items:center; gap:8px; margin-top:8px; }
  </style>
</head>
<body>
  <div class="container">
    <a class="back" href="{{ url_for('manager.view_contracts') }}">‚Üê Back to Contracts</a>
    <h1>Edit Contract: {{ contract.contract_number }}</h1>

    <!-- use your manager blueprint endpoint names -->
    <form method="post" action="{{ url_for('manager.update_contract', contract_id=contract.id) }}">
      <!-- CONTRACT FIELDS -->
      <div class="card">
        <div class="grid-2">
          <div>
            <label for="contract_number">Contract Number</label>
            <input id="contract_number" name="contract_number" type="text" required
                   value="{{ contract.contract_number or '' }}">
          </div>
          <div>
            <label for="school_name">School Name</label>
            <input id="school_name" name="school_name" type="text" required
                   value="{{ contract.school_name or '' }}">
          </div>
        </div>

        <div class="grid-2" style="margin-top:var(--gap);">
          <div>
            <label for="school_postcode">School Postcode</label>
            <input id="school_postcode" name="school_postcode" type="text"
                   value="{{ contract.school_postcode or '' }}">
            <small class="hint">Used for route distance calculations.</small>
          </div>
          <div>
            <label for="required_vehicle_size">Required Vehicle Size</label>
            <input id="required_vehicle_size" name="required_vehicle_size" type="text"
                   value="{{ contract.required_vehicle_size or '' }}">
          </div>
        </div>

        <!-- Correct mapping for SCHOOL times -->
        <div class="grid-2" style="margin-top:var(--gap);">
          <div>
            <label for="school_start_time">School Start Time</label>
            <input id="school_start_time" name="school_start_time" type="time" required
                   value="{{ contract.school_start_time.strftime('%H:%M') if contract.school_start_time else '' }}">
          </div>
          <div>
            <label for="school_finish_time">School Finish Time</label>
            <input id="school_finish_time" name="school_finish_time" type="time" required
                   value="{{ contract.school_finish_time.strftime('%H:%M') if contract.school_finish_time else '' }}">
          </div>
        </div>

        <!-- Separate ROUTE times -->
        <div class="grid-2" style="margin-top:var(--gap);">
          <div>
            <label for="route_start_time">Route Start Time</label>
            <input id="route_start_time" name="route_start_time" type="time"
                   value="{{ contract.route_start_time.strftime('%H:%M') if contract.route_start_time else '' }}">
          </div>
          <div>
            <label for="route_finish_time">Route Finish Time</label>
            <input id="route_finish_time" name="route_finish_time" type="time"
                   value="{{ contract.route_finish_time.strftime('%H:%M') if contract.route_finish_time else '' }}">
          </div>
        </div>

        <div class="grid-2" style="margin-top:var(--gap);">
          <div>
            <label for="commute_time">Commute Time (mins)</label>
            <input id="commute_time" name="commute_time" type="number" min="0" step="1"
                   value="{{ contract.commute_time if contract.commute_time is not none else '' }}">
          </div>
          <div class="inline">
            <input id="escort_required" name="escort_required" type="checkbox" value="1"
                   {% if contract.escort_required %}checked{% endif %}>
            <label for="escort_required" style="margin:0;">Escort Required</label>
          </div>
        </div>
      </div>

      <hr>

      <!-- CHILDREN -->
      <h2>Children</h2>
      <div id="children-container">
        {% for child in contract.children %}
          <div class="card child" data-child>
            <input type="hidden" name="child_id[]" value="{{ child.id }}">
            <div class="row">
              <div>
                <label>Child Name</label>
                <input name="child_name[]" type="text" required value="{{ child.name or '' }}">
              </div>
              <div>
                <label>Child Address</label>
                <input name="child_address[]" type="text" required value="{{ child.address or '' }}">
              </div>
            </div>
            <div class="row" style="margin-top:var(--gap);">
              <div>
                <label>Child Postcode (optional)</label>
                <input name="child_postcode[]" type="text" value="{{ child.child_postcode or '' }}">
              </div>
              <div class="actions" style="align-items:end; justify-content:flex-end;">
                <button type="button" class="btn btn-danger" data-remove>Remove</button>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="actions">
        <button type="button" class="btn btn-ghost" id="add-child">+ Add Child</button>
      </div>

      <div class="actions" style="margin-top:22px;">
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <a class="btn btn-ghost" href="{{ url_for('manager.view_contracts') }}">Cancel</a>
      </div>
    </form>
  </div>

  <template id="child-template">
    <div class="card child" data-child>
      <!-- no child_id[] for new rows -->
      <div class="row">
        <div>
          <label>Child Name</label>
          <input name="child_name[]" type="text" required>
        </div>
        <div>
          <label>Child Address</label>
          <input name="child_address[]" type="text" required>
        </div>
      </div>
      <div class="row" style="margin-top:var(--gap);">
        <div>
          <label>Child Postcode (optional)</label>
          <input name="child_postcode[]" type="text">
        </div>
        <div class="actions" style="align-items:end; justify-content:flex-end;">
          <button type="button" class="btn btn-danger" data-remove>Remove</button>
        </div>
      </div>
    </div>
  </template>

  <script>
    const container = document.getElementById('children-container');
    const addBtn = document.getElementById('add-child');
    const tpl = document.getElementById('child-template');

    addBtn.addEventListener('click', () => {
      const clone = tpl.content.firstElementChild.cloneNode(true);
      container.appendChild(clone);
    });

    container.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-remove]');
      if (!btn) return;
      const block = btn.closest('[data-child]');
      if (block) block.remove();
    });
  </script>
</body>
</html>
