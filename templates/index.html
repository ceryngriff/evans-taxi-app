{% extends 'base.html' %}

{% block title %}Manager Dashboard{% endblock %}

{% block content %}
<div class="container py-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-4">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <h1 class="text-3xl font-bold text-gray-800 mb-6">Evans Taxis ‚Äì Manager Dashboard</h1>
    <!-- üó∫Ô∏è Live Driver Map -->
<div class="info-box">
    <h2 class="text-xl font-semibold text-gray-700 mb-3">üó∫Ô∏è Live Driver Locations</h2>
    <div id="driverMap" style="height: 500px;"></div>
</div>

<!-- Leaflet.js CDN -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

<script>
    const map = L.map('driverMap').setView([53.48, -2.24], 11);  // Example: Manchester

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    fetch('/api/driver-locations')
        .then(response => response.json())
        .then(locations => {
            locations.forEach(loc => {
                L.marker([loc.lat, loc.lng])
                    .addTo(map)
                    .bindPopup(`Driver ID: ${loc.driver_id}<br>Time: ${loc.timestamp}`);
            });
        })
        .catch(err => console.error("Map fetch error:", err));
</script>
    

    <!-- ‚ö†Ô∏è Missed Runs Today -->
    <div class="info-box">
        <h2>‚ö†Ô∏è Missed Runs Today</h2>
        {% if runs %}
            <table class="styled-table">
                <thead>
                    <tr>
                        <th>Staff</th>
                        <th>Shift</th>
                        <th>Contract</th>
                        <th>Reason</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for run in runs %}
                        <tr>
                            <td>{{ run.staff_name }}</td>
                            <td>{{ run.shift }}</td>
                            <td>{{ run.contract_number }}</td>
                            <td>{{ run.reason }}</td>
                            <td>{{ run.date }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>‚úÖ All runs completed today.</p>
        {% endif %}
    </div>

    <!-- üåø Upcoming Leave Section -->
    <div class="info-box">
        <h2 class="text-xl font-semibold text-gray-700 mb-3">üìÖ Upcoming Leave (Next Week)</h2>
        {% if upcoming_leave %}
            <ul class="list-disc list-inside text-gray-700">
                {% for leave in upcoming_leave %}
                    <li>
                        {{ leave.person_type.title() }}: 
                        {% if leave.person_type == 'driver' %}
                            {{ drivers | selectattr("id", "equalto", leave.person_id) | map(attribute="name") | list | first }}
                        {% else %}
                            {{ escorts | selectattr("id", "equalto", leave.person_id) | map(attribute="name") | list | first }}
                        {% endif %}
                        ‚Äî {{ leave.start_date }} to {{ leave.end_date }} ({{ leave.reason or "No reason given" }})
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-gray-600">No upcoming leave scheduled.</p>
        {% endif %}
    </div>

    <!-- üöê Vehicle Checks -->
    <!-- üöå Upcoming Vehicle Maintenance Deadlines -->
<div class="info-box">
  <h2 class="text-xl font-semibold text-gray-700 mb-3">üöå Upcoming Vehicle Maintenance</h2>
  {% if upcoming_vehicle_deadlines %}
    <ul class="list-disc list-inside text-gray-700">
      {% for v in upcoming_vehicle_deadlines %}
        <li>
          {{ v.registration }}
          {% if v.mot_renewal_date %} ‚Äî MOT: {{ v.mot_renewal_date.strftime('%Y-%m-%d') }}{% endif %}
          {% if v.plate_expiry_date %} | Plate: {{ v.plate_expiry_date.strftime('%Y-%m-%d') }}{% endif %}
          {% if v.tax_expiry_date %} | Tax: {{ v.tax_expiry_date.strftime('%Y-%m-%d') }}{% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-gray-600">No upcoming vehicle maintenance deadlines.</p>
  {% endif %}
</div>
<div class="info-box">
  <h3>üö® Vehicle Checks Not Completed Today</h3>
  {% if missing_checks is defined and missing_checks|length > 0 %}
    <ul>
      {% for staff in missing_checks %}
        <li>{{ staff.name }} (Driver ID: {{ staff.id }})</li>
      {% endfor %}
    </ul>
  {% else %}
    <p>‚úÖ All vehicle checks are done today.</p>
  {% endif %}
</div>
       
    <!-- üö® Badge Renewals -->
<div class="info-box">
    <h2 class="text-xl font-semibold text-gray-700 mb-3">üö® Upcoming Driver Badge Renewals (Next 8 Weeks)</h2>
    {% if upcoming_badge_renewals %}
        <ul class="list-disc list-inside text-gray-700">
            {% for driver in upcoming_badge_renewals %}
                <li><strong>{{ driver.name }}</strong> ‚Äî due on {{ driver.badge_renewal_date.strftime('%Y-%m-%d') }}</li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="text-gray-600">No upcoming badge renewals in the next 8 weeks.</p>
    {% endif %}
</div>

</div>
{% endblock %}
